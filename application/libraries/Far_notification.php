<?php if ( ! defined('BASEPATH')) exit('No direct script access allowed');include APPPATH . 'third_party/pusher/vendor/autoload.php';include APPPATH . 'third_party/pusher-beams/vendor/autoload.php';class Far_notification {    private $CI;    public function __construct(){        $this->CI =& get_instance();        $this->CI->load->helper('url');        $this->CI->load->library('session');        $this->CI->load->database();    }    function list_latest_notification($uacc_id , $limit = 10){        $output = array();        $query = $this->CI->db->query("SELECT * FROM view_notification_list WHERE receiver_uacc_id='".$uacc_id."' ORDER BY create_dttm DESC LIMIT ".$limit);        if($query->num_rows() > 0){            $output = $query->result_array();        }        return $output;    }    function list_five_latest_unread_notification($uacc_id){        $query = $this->CI->db->query("SELECT * FROM view_notification_list WHERE receiver_uacc_id='".$uacc_id."' AND notification_status='unread' ORDER BY create_dttm DESC LIMIT 5");        return $query->result_array();    }    function get_latest_unread_order_notification($uacc_id){        $query = $this->CI->db->query("SELECT * FROM view_notification_list WHERE receiver_uacc_id='".$uacc_id."' AND notification_status='unread' AND notification_type='simcard_order' ORDER BY create_dttm DESC");        return $query->row_array();    }    function count_read_notification($receiver_uacc_id, $project_id = NULL){        if(strlen($project_id) > 0){            $query = $this->CI->db->query("SELECT * FROM view_notification_list WHERE receiver_uacc_id='".$receiver_uacc_id."' AND notification_status='read' AND project_id='".$project_id."'");        }else{            $query = $this->CI->db->query("SELECT * FROM view_notification_list WHERE receiver_uacc_id='".$receiver_uacc_id."' AND notification_status='read'");        }        return $query->num_rows();    }    function count_unread_notification($receiver_uacc_id){        $query = $this->CI->db->query("SELECT * FROM view_notification_list WHERE receiver_uacc_id='".$receiver_uacc_id."' AND notification_status='unread'");        return $query->num_rows();    }    function get_notification_detail($notification_id){        $query = $this->CI->db->query("SELECT             n.notification_id,            n.receiver_uacc_id,            n.notification_type,            n.notification_title,            n.notification_message,            n.primary_id_name,            n.primary_id_value,            n.notification_status,            n.sender_uacc_id         FROM notification_detail n         WHERE n.notification_id='".$notification_id."'         ");        $notification_detail = $query->row_array();        if($notification_detail['notification_type'] == 'memo_received'){            $this->CI->load->library('ob/far_memo');            //get memo detail            $memo_detail = $this->CI->far_memo->get_memo_detail($notification_detail['primary_id_value']);            $notification_detail['notification_detail'] = $memo_detail;        }        return $notification_detail;    }    function get_notification_detail_from_onesignal($onesignal_message_id){        $query = $this->CI->db->query("SELECT             pn.msg_title,            pn.msg_text,            pn.pn_type,            pn.primary_id_name,            pn.primary_id_value         FROM onesignal_pnout pn         WHERE pn.onesignal_message_id='".$onesignal_message_id."'         ");        $notification_detail = $query->row_array();        if($notification_detail['pn_type'] == 'memo_received'){            $this->CI->load->library('ob/far_memo');            //get memo detail            $memo_detail = $this->CI->far_memo->get_memo_detail($notification_detail['primary_id_value']);            $notification_detail['notification_detail'] = $memo_detail;        }        return $notification_detail;    }    function count_total_notification($receiver_uacc_id){        $query = $this->CI->db->query("SELECT * FROM notification_detail WHERE receiver_uacc_id='".$receiver_uacc_id."'");        return $query->num_rows();    }    function pagination_list_all_notification($receiver_uacc_id, $limit, $start){        $query = $this->CI->db->query("SELECT * FROM notification_detail WHERE receiver_uacc_id='".$receiver_uacc_id."' ORDER BY create_dttm DESC LIMIT $start, $limit");        $list_all_notification = $query->result_array();        foreach($list_all_notification as $a => $b){            $sender_fullname = $this->CI->far_users->get_profile_by_column('uacc_id', $b['sender_uacc_id'], 'fullname');            //memo            if($b['notification_type'] == 'memo_received'){                $memo_detail = $this->CI->far_memo->get_memo_detail($b['primary_id_value']);                $list_all_notification[$a]['notification_detail'] = $memo_detail;                $list_all_notification[$a]['view'] = array(                    'line_first' => "MEMO#".$memo_detail['memo_id']. "( ".$memo_detail['memo_category_name'].")",                    'line_second' => $this->CI->far_date->convert_format($memo_detail['create_dttm'], 'l, j M Y'),                    'line_third' => 'Submit by '.$sender_fullname                );            }elseif($b['notification_type'] == 'rfi_received'){                $rfi_detail = $this->CI->far_rfi->get_rfi_detail($b['primary_id_value']);                $list_all_notification[$a]['notification_detail'] = $rfi_detail;                $list_all_notification[$a]['view'] = array(                    'line_first' => "RFI#".$rfi_detail['rfi_id']. "( ".$rfi_detail['rfi_category_name'].")",                    'line_second' => $this->CI->far_date->convert_format($rfi_detail['create_dttm'], 'l, j M Y'),                    'line_third' => 'Submit by '.$sender_fullname                );            }        }        return $list_all_notification;    }    function create_notification($notification_data){        $notification_data['create_dttm'] = date("Y-m-d H:i:s");        $this->CI->db->insert('notification_detail', $notification_data);        $notification_id = $this->CI->db->insert_id();        /*        //check notification subscription        $query = $this->CI->db->query("SELECT * FROM onesignal_subscription WHERE uacc_id='".$notification_data['receiver_uacc_id']."'");        if($query->num_rows() > 0){            $this->CI->load->library('onesignal');            $onesignal_data = array();            if($notification_data['launchURL']){                $onesignal_data['launchURL'] = $notification_data['launchURL'];            }            $response = $this->CI->onesignal->send_pn_to_user($notification_data['receiver_uacc_id'], $notification_data['notification_title'], $notification_data['notification_message'], $onesignal_data);            if(count($response) > 0){                $this->update_notification_detail('notification_id', $notification_id, 'onesignal_notification_id', $response['id']);            }            $send_whatsapp = "yes";            if($send_whatsapp == "yes"){                $this->CI->load->library('far_wabot');                //send whatsapp                // Should use UTF8                $message_filtered = utf8_encode($notification_data['notification_message']);                // Whatsapp patterns                $nl  = "%0D%0A"; // newline                $space = "%20";    // space                $receiver_msisdn = $this->CI->far_users->get_profile_by_column('uacc_id', $notification_data['receiver_uacc_id'], 'mobile_number');                if(strlen($receiver_msisdn) > 8){                    // Replace newline to Whatsapp format                    //$message_filtered = str_replace( array(" ","<br>","\n", "\r\n"), array($space,$nl,$nl,$nl), $message_filtered);                    $receiver_msisdn = $this->CI->far_helper->fix_msisdn($receiver_msisdn);                    if($notification_data['module_name'] == 'score_report' && $notification_data['notification_type'] == 'score_report_ready'){                        $score_report_detail = $this->CI->far_score->get_score_report_by_column('score_report_id', $notification_data['primary_id_value']);                        $media_url = base_url()."page/view_score_report/?score_report_code=".$score_report_detail['score_report_code'];                        $filename = $score_report_detail['score_report_code'].'.pdf';                        $this->CI->far_wabot->queue_file($receiver_msisdn, $message_filtered, $media_url, $filename);                    }else{                        $this->CI->far_wabot->queue_text($receiver_msisdn, $message_filtered);                    }                }            }        }        return $this->CI->db->insert_id();        */        return $notification_id;    }    function update_notification_detail($key, $key_value, $column, $value){        $data = array(            $column => $value        );        $this->CI->db->where($key, $key_value);        $this->CI->db->update('notification_detail', $data);    }    function is_notification_exists($notification_type, $primary_id_name, $primary_id_value, $receiver_uacc_id){        $query = $this->CI->db->query("SELECT * FROM notification_detail WHERE notification_type='".$notification_type."' AND primary_id_name='".$primary_id_name."' AND primary_id_value='".$primary_id_value."' AND receiver_uacc_id='".$receiver_uacc_id."'");        if($query->num_rows() > 0){            return true;        }else{            return false;        }    }    function get_notification_detail_from_onesignal_data($notification_type, $primary_id_name, $primary_id_value, $receiver_uacc_id){        $query = $this->CI->db->query("SELECT * FROM notification_detail WHERE notification_type='".$notification_type."' AND primary_id_name='".$primary_id_name."' AND primary_id_value='".$primary_id_value."' AND receiver_uacc_id='".$receiver_uacc_id."'");        $notification_detail = array();        if($query->num_rows() > 0){            $notification_detail = $query->row_array();            if($notification_detail['primary_id_name'] == 'memo_id'){                //get memo detail                $memo_detail = $this->CI->far_memo->get_memo_detail($notification_detail['primary_id_value'], $notification_detail['msg_id'], $notification_detail['receiver_uacc_id']);                $notification_detail['notification_detail'] = $memo_detail;            }            if($notification_detail['primary_id_name'] == 'ncr_id'){                $this->CI->load->library('ob/far_ncr');                //get memo detail                $ncr_detail = $this->CI->far_ncr->get_ncr_detail($notification_detail['primary_id_value'], $notification_detail['msg_id'], $notification_detail['receiver_uacc_id']);                $notification_detail['notification_detail'] = $ncr_detail;            }            if($notification_detail['primary_id_name'] == 'ncr_respond_id'){                $this->CI->load->library('ob/far_ncr');                //get memo detail                //get ncr_respond_id by ncr_id                $query2 = $this->CI->db->query("SELECT ncr_id FROM ncr_respond WHERE ncr_respond_id='".$notification_detail['primary_id_value']."'");                $ncr_id = $query2->row()->ncr_id;                //echo $ncr_id; exit();                $ncr_detail = $this->CI->far_ncr->get_ncr_detail($ncr_id, $notification_detail['msg_id'], $notification_detail['receiver_uacc_id']);                $notification_detail['notification_detail'] = $ncr_detail;            }            if($notification_detail['primary_id_name'] == 'rfi_id'){                $this->CI->load->library('ob/far_rfi');                //get memo detail                $ncr_detail = $this->CI->far_rfi->get_rfi_detail($notification_detail['primary_id_value'], $notification_detail['msg_id'], $notification_detail['receiver_uacc_id']);                $notification_detail['notification_detail'] = $ncr_detail;            }            if($notification_detail['primary_id_name'] == 'mfa_id'){                $this->CI->load->library('ob/far_mfa');                //get memo detail                $mfa_detail = $this->CI->far_mfa->get_mfa_detail($notification_detail['primary_id_value'], $notification_detail['msg_id'], $notification_detail['receiver_uacc_id']);                $notification_detail['notification_detail'] = $mfa_detail;            }            if($notification_detail['primary_id_name'] == 'msa_id'){                $this->CI->load->library('ob/far_msa');                //get memo detail                $msa_detail = $this->CI->far_msa->get_msa_detail($notification_detail['primary_id_value'], $notification_detail['msg_id'], $notification_detail['receiver_uacc_id']);                $notification_detail['notification_detail'] = $msa_detail;            }            if($notification_detail['primary_id_name'] == 'rvo_id'){                $this->CI->load->library('ob/far_rvo');                //get memo detail                $rvo_detail = $this->CI->far_rvo->get_rvo_detail($notification_detail['primary_id_value'], $notification_detail['msg_id'], $notification_detail['receiver_uacc_id']);                $notification_detail['notification_detail'] = $rvo_detail;            }            if($notification_detail['primary_id_name'] == 'psi_event_id'){                $this->CI->load->library('ob/far_psi_event');                //get memo detail                $rvo_detail = $this->CI->far_psi_event->get_psi_event_detail($notification_detail['primary_id_value'], $notification_detail['msg_id'], $notification_detail['receiver_uacc_id']);                $notification_detail['notification_detail'] = $rvo_detail;            }            if($notification_detail['primary_id_name'] == 'psi_report_id'){                $this->CI->load->library('ob/far_psi_report');                $this->CI->load->library('ob/far_psi_event');                //get memo detail                $psi_report_detail = $this->CI->far_psi_report->get_psi_report_detail($notification_detail['primary_id_value'], $notification_detail['msg_id'], $notification_detail['receiver_uacc_id']);                if($psi_report_detail['report_type'] == 'existing'){                    $psi_event_detail = $this->CI->far_psi_event->get_psi_event_detail($psi_report_detail['psi_event_id']);                    $psi_report_detail['psi_event_detail'] = $psi_event_detail;                }                $notification_detail['notification_detail'] = $psi_report_detail;            }            if($notification_detail['primary_id_name'] == 'claim_id'){                $this->CI->load->library('ob/far_claim');                //get memo detail                $claim_detail = $this->CI->far_claim->get_claim_detail($notification_detail['primary_id_value'], $notification_detail['msg_id'], $notification_detail['receiver_uacc_id']);                $notification_detail['notification_detail'] = $claim_detail;            }        }        return $notification_detail;    }    function list_push_notification_pagination($limit, $start, $uacc_id, $search_term, $pn_type = NULL){        $where = "";        if(strlen($search_term) > 0){            $where .= " AND (n.notification_message LIKE '%".$search_term."%' OR n.notification_title LIKE '%".$search_term."%' OR n.sender_fullname LIKE '%".$search_term."%')";        }        if(!is_null($pn_type)){            if($pn_type == 'unread'){                $where .= " AND n.notification_status='unread'";            }elseif($pn_type == 'read'){                $where .= " AND n.notification_status='read'";            }else{                $where .= " AND n.notification_type LIKE '".$pn_type."%'";            }        }        $query = $this->CI->db->query("            SELECT                n.notification_id,                n.receiver_uacc_id,                n.notification_type,                n.notification_title,                n.notification_message,                n.primary_id_name,                n.primary_id_value,                n.notification_status,                n.sender_uacc_id,                n.read_dttm,                n.create_dttm,                n.sender_fullname,                n.sender_profile_pic_url            FROM view_notification_list n            WHERE FIND_IN_SET('".$uacc_id."', n.receiver_uacc_id)            $where            ORDER BY             n.create_dttm DESC         LIMIT ".$start.", ".$limit);        $rows = $query->result_array();        //print_r($rows); exit();        $final_output = array();        if($query->num_rows() > 0){            $final_output = $query->result_array();        }        /**         * Change all params contains id in the name to integer         */        foreach($final_output as $a => $b){            if(strpos($a, "_id") !== false){                if($a != 'primary_id_name'){                    $final_output[$a] = (int)$b;                }            }elseif(is_array($b)){                foreach($b as $c => $d){                    if(strpos($c, "_id") !== false){                        if($c != 'primary_id_name'){                            $final_output[$a][$c] = (int)$d;                        }                    }                }            }        }        return $final_output;        //$this->CI->db->limit($limit, $start);        //$query = $this->CI->db->get('post_attachment');        //return $query->result();    }    function clear_all_notification($uacc_id){        $query = $this->CI->db->query("UPDATE notification_detail SET notification_status='read' WHERE receiver_uacc_id='".$uacc_id."'");    }    function count_wallet_unread_transaction($userId){        $query = $this->CI->db->query("            SELECT COALESCE(COUNT(notification_id), 0) AS total_notitication FROM notification_detail WHERE                 receiver_uacc_id='".$userId."'                 AND user_id_db_name='userId'                AND notification_type='bonus_simcard_registration'                AND notification_status='unread'        ");        $count_bonus_simcard_registration = $query->row()->total_notitication;        if($count_bonus_simcard_registration >= 100){            $count_bonus_simcard_registration = 99;        }        return $count_bonus_simcard_registration;    }    function mark_notification_read_wallet_unread_transaction($userId){        $query = $this->CI->db->query("UPDATE notification_detail SET notification_status='read' WHERE                 receiver_uacc_id='".$userId."'                 AND user_id_db_name='userId'                AND notification_type='bonus_simcard_registration'                AND notification_status='unread'        ");    }}?>